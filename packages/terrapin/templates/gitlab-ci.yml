# Sui dApp E2E Testing with Playwright
# Generated by @tortoiseos/terrapin
#
# This is a GitLab CI configuration for running E2E tests
# Copy this file to .gitlab-ci.yml in your repository

image: oven/bun:latest

stages:
  - install
  - test
  - report

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - ~/.cache/ms-playwright/

variables:
  NEXT_PUBLIC_ENABLE_BURNER_WALLET: 'true'
  NEXT_PUBLIC_SUI_NETWORK: 'localnet'

install:
  stage: install
  script:
    - bun install
    - bunx playwright install --with-deps chromium
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 day

e2e-tests:
  stage: test
  needs: [install]
  before_script:
    # Install Sui CLI
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source "$HOME/.cargo/env"
    - cargo install --locked --git https://github.com/MystenLabs/sui.git --branch main sui
    # Start Sui localnet
    - export PATH="$HOME/.cargo/bin:$PATH"
    - sui start &
    - sleep 10
  script:
    - bun run build
    - bun run test:e2e
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    reports:
      junit: test-results/junit.xml
    expire_in: 30 days

pages:
  stage: report
  needs: [e2e-tests]
  script:
    - mkdir -p public
    - cp -r playwright-report/* public/
  artifacts:
    paths:
      - public
  only:
    - main
